# This is a basic workflow to help you get started with Actions

name: MLOps test

# Controls when the workflow will run
on:
  workflow_dispatch:
    inputs:
      create_compute:
        description: 'Create compute'
        type: boolean
        default: true
        required: true
      create_env:
        description: 'Create environment'
        type: boolean
        default: true
        required: true
        
env:
  WORKDIR: ${{ github.workspace }}
  GIT_SHA: ${{ github.sha }} # Set the SHA to use in the code

  AZ_CLI_PATH: ${{ github.workspace }}/azureml-2.0-cli
  AZ_WORKSPACE: diabetes-prediction-v2
  AZ_COMPUTE: cpu-one

  ENV_VERSION: 1.0.1
  
jobs:

  az-pipeline:
    runs-on: ubuntu-20.04

    steps:
      - uses: actions/checkout@v2

      - name: add extension by name
        run: az extension add --name ml

      - name: azure login  
        run: az login --service-principal -u ${{ secrets.CLIENT_ID }} -p ${{ secrets.CLIENT_SECRET }} --tenant ${{ secrets.TENANT_ID }}
      
      - name: set default workspace
        run: az configure --defaults group=mlops-bart workspace=${{ env.AZ_WORKSPACE }}
        
      - name: create compute
        if: inputs.create_compute
        run: az ml compute create --file ${{ env.AZ_CLI_PATH }}/config/compute.yml
                                  --set name=${{ env.AZ_COMPUTE }}
    
      - name: create environment
        if: inputs.create_env
        run: az ml environment create --file ${{ env.AZ_CLI_PATH }}/config/diabetes-prediction-env.yml
                                      --version ${{ env.ENV_VERSION }}
                                      --set tags.git-sha=${{ env.GIT_SHA }}
